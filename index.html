<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Pizzer√≠a "El Olimpo"</title>
    <style>
        /* Estilos generales */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f8f8f8; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #d32f2f; border-bottom: 2px solid #d32f2f; padding-bottom: 5px; margin-top: 25px; }

        /* Estilos de productos y controles */
        .producto { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dotted #eee; }
        .producto-info { flex-grow: 1; }
        .producto-info h4 { margin: 0; font-size: 1.1em; }
        .producto-info p { margin: 2px 0 0; font-size: 0.9em; color: #777; }
        .producto-precio { font-weight: bold; color: #4CAF50; margin-left: 15px; width: 80px; text-align: right; } 
        .controls { display: flex; align-items: center; gap: 5px; }
        .controls button { background-color: #d32f2f; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; transition: background-color 0.3s; }
        .controls button:hover { background-color: #b71c1c; }
        .controls input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 4px; }
        
        /* Estilos del Total y Bot√≥n */
        .total-container { margin-top: 25px; padding: 15px; background-color: #ffe0b2; border: 1px solid #ffcc80; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .total-container span { font-size: 1.4em; color: #e65100; font-weight: bold; }
        .btn-ordenar { background-color: #00796b; color: white; border: none; padding: 12px 20px; font-size: 1.1em; border-radius: 6px; cursor: pointer; margin-top: 15px; width: 100%; transition: background-color 0.3s; }
        .btn-ordenar:hover { background-color: #004d40; }

        /* Estilos de Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%;
            text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .modal-content h3 { color: #d32f2f; }
        .modal-content ul { list-style: none; padding: 0; text-align: left; margin-bottom: 20px; }
        .modal-content ul li { padding: 5px 0; border-bottom: 1px dotted #ddd; }
        .modal-content .total { font-size: 1.2em; font-weight: bold; color: #00796b; margin-top: 10px; }
        .modal-content .btn-whatsapp { background-color: #25D366; color: white; margin-top: 15px; }
        .modal-content .btn-whatsapp:hover { background-color: #1EBE4A; }

        /* Estilos de Confirmaci√≥n */
        #confirmacion-modal .modal-content { padding: 20px; max-width: 300px; z-index: 101; }
        #confirmacion-modal h3 { color: #25D366; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Pizzer√≠a "El Olimpo"</h1> 

        <div id="menu-secciones">
            <p>Cargando men√∫...</p>
        </div>
        
        <div class="total-container">
            <div>Total estimado del pedido:</div>
            <span><span id="moneda-total">Bs</span><span id="total">0.00</span></span>
        </div>

        <button class="btn-ordenar" onclick="mostrarResumen()">Generar Orden</button>
    </div>

    <div id="resumen-modal" class="modal">
        <div class="modal-content">
            <h3>üìù Resumen de tu Pedido</h3>
            <ul id="resumen-lista"></ul>
            <p class="total">Total: <span id="moneda-resumen">Bs</span><span id="resumen-total">0.00</span></p>
            <button class="btn-ordenar btn-whatsapp" onclick="enviarPedidoWhatsApp()">üìû Ordenar por WhatsApp</button>
            <button class="btn-ordenar" style="background-color: #777;" onclick="cerrarResumen()">Volver al Men√∫</button>
        </div>
    </div>

    <div id="confirmacion-modal" class="modal">
        <div class="modal-content">
            <h3>‚úÖ Pedido Enviado</h3>
            <p>Revisa tu WhatsApp para finalizar la compra.</p>
            <button onclick="cerrarConfirmacion()" class="btn-ordenar" style="width: 50%; margin: 15px auto 0;">ACEPTAR</button>
        </div>
    </div>


    <script>
        // *** CONFIGURACI√ìN CLAVE ***
        // Reemplaza con el n√∫mero de tel√©fono de la pizzer√≠a.
        const NUMERO_WHATSAPP = '584122525407'; 

        // ESTA ES LA URL DE TU GOOGLE SHEETS PUBLICADO EN FORMATO CSV
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7PURG0pSdhs-owKEJTasIENYz59Mnl6aSiOwuZb0LHftbOFpGzjAkAWBbIyMWtUpuTPKsuegBTVOZ/pub?output=csv'; 
        // --------------------------------------------------------------------

        let productosDB = {}; 
        const carrito = {};

        // --- FUNCIONES CENTRALES DE CARGA Y PROCESAMIENTO ---

        async function cargarMenu() {
            document.getElementById('menu-secciones').innerHTML = '<p>Intentando cargar datos...</p>';
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}.`);
                }
                const csvText = await response.text();
                productosDB = parsearCSV(csvText);

                renderizarMenu();
                actualizarTotal();
            } catch (error) {
                console.error("Error en cargarMenu:", error);
                document.getElementById('menu-secciones').innerHTML = '<h2>¬°Error! No se pudo cargar el men√∫.</h2><p>Verifica la URL, la publicaci√≥n y el formato de datos (ej: el precio).</p>';
            }
        }
        
        function parsearCSV(csv) {
            const data = {};
            const lineas = csv.replace(/\r/g, '').split('\n');
            
            console.log("DEBUG: Iniciando an√°lisis con separador: , (coma)");

            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (linea.length === 0) continue; 

                // Usamos coma (,) como separador de columnas
                const columnas = linea.split(','); 
                
                if (columnas.length < 5) {
                    console.error("DEBUG: L√≠nea ignorada (menos de 5 columnas):", linea);
                    continue; 
                }

                try {
                    // 1. Mapea y limpia las columnas: ID, NOMBRE, PRECIO, DESCRIPCI√ìN, CATEGOR√çA
                    const [id, nombre, precioStr, desc, categoria] = columnas.map(c => c.trim().replace(/"/g, ''));
                    
                    if (!id || !precioStr || !categoria) {
                        console.error("DEBUG: Fila con campos vac√≠os esenciales:", linea);
                        continue;
                    }
                    
                    // 2. Convierte la coma decimal (,) a punto decimal (.)
                    // Esto es √∫til si Google Sheets a√∫n pone comas, aunque el separador de columna sea la coma.
                    const precioLimpio = precioStr.replace(',', '.'); 
                    const precio = parseFloat(precioLimpio);

                    if (isNaN(precio)) {
                        console.error("DEBUG: FALLO CR√çTICO: El PRECIO no es un n√∫mero. Precio recibido:", precioStr, "en l√≠nea:", linea);
                        continue;
                    }

                    const producto = { id, nombre, precio, desc, categoria };

                    // 3. Agrupa por Categor√≠a
                    if (!data[categoria]) {
                        data[categoria] = [];
                    }
                    data[categoria].push(producto);
                    
                } catch (e) {
                    console.error("DEBUG: Error inesperado al procesar l√≠nea:", linea, e);
                }
            }
            console.log("DEBUG: Datos procesados (productosDB):", data);
            return data;
        }


        // --- FUNCIONES DE RENDERIZADO Y L√ìGICA ---

        function renderizarMenu() {
            const menuDiv = document.getElementById('menu-secciones');
            let html = '';
            
            for (const seccion in productosDB) {
                html += `<h2>${seccion}</h2><div class="menu-section">`;
                productosDB[seccion].forEach(p => {
                    carrito[p.id] = 0; 
                    // Mostrando en Bol√≠vares
                    html += `<div class="producto"><div class="producto-info"><h4>${p.nombre}</h4><p>${p.desc}</p></div><div class="producto-precio">Bs ${p.precio.toFixed(2)}</div><div class="controls"><button onclick="cambiarCantidad('${p.id}', -1)">-</button><input type="number" id="cant-${p.id}" value="0" min="0" onchange="actualizarCarrito(this, '${p.id}')"><button onclick="cambiarCantidad('${p.id}', 1)">+</button></div></div>`;
                });
                html += '</div>';
            }
            menuDiv.innerHTML = html;
        }

        function cambiarCantidad(id, cambio) {
            const input = document.getElementById(`cant-${id}`);
            let nuevaCantidad = parseInt(input.value) + cambio;
            if (nuevaCantidad < 0) nuevaCantidad = 0;
            input.value = nuevaCantidad;
            carrito[id] = nuevaCantidad; 
            actualizarTotal();
        }

        function actualizarCarrito(inputElement, id) {
            let nuevaCantidad = parseInt(inputElement.value);
            if (isNaN(nuevaCantidad) || nuevaCantidad < 0) {
                nuevaCantidad = 0;
                inputElement.value = 0; 
            }
            carrito[id] = nuevaCantidad; 
            actualizarTotal();
        }

        function obtenerItemsPedidos() {
            const itemsPedidos = [];
            for (const seccion in productosDB) {
                productosDB[seccion].forEach(p => {
                    const cantidad = carrito[p.id];
                    if (cantidad > 0) {
                        const precio = p.precio; 
                        const subtotal = cantidad * precio;
                        itemsPedidos.push({ nombre: p.nombre, cantidad: cantidad, subtotal: subtotal });
                    }
                });
            }
            return itemsPedidos;
        }

        function actualizarTotal() {
            let totalGeneral = 0;
            obtenerItemsPedidos().forEach(item => { totalGeneral += item.subtotal; });
            document.getElementById('total').textContent = totalGeneral.toFixed(2);
        }

        // --- Funciones de Modal y WhatsApp ---

        function mostrarResumen() {
            const itemsPedidos = obtenerItemsPedidos();
            const modal = document.getElementById('resumen-modal');
            if (itemsPedidos.length === 0) {
                alert('¬°Tu carrito est√° vac√≠o! Agrega productos para generar una orden.');
                return;
            }
            // Mostrando en Bol√≠vares
            document.getElementById('resumen-lista').innerHTML = itemsPedidos.map(item => `<li>**${item.cantidad}x** ${item.nombre} <span style="float:right;">Bs ${item.subtotal.toFixed(2)}</span></li>`).join('');
            document.getElementById('resumen-total').textContent = document.getElementById('total').textContent;
            modal.style.display = 'flex';
        }

        function cerrarResumen() {
            document.getElementById('resumen-modal').style.display = 'none';
        }

        function cerrarConfirmacion() {
            document.getElementById('confirmacion-modal').style.display = 'none';
        }

        function enviarPedidoWhatsApp() {
            const items = obtenerItemsPedidos();
            const total = document.getElementById('total').textContent;

            let mensaje = `¬°Hola! Mi orden para Pizzer√≠a "El Olimpo" es la siguiente:\n\n`;
            items.forEach(item => { mensaje += `${item.cantidad}x ${item.nombre}\n`; });
            // Agregando "Bs" al mensaje de WhatsApp
            mensaje += `\n*TOTAL ESTIMADO: Bs ${total}*`;
            mensaje += '\n\nPor favor, necesito confirmar el pedido y los detalles de pago. ¬°Gracias!';

            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/${NUMERO_WHATSAPP}?text=${mensajeCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
            cerrarResumen();
            document.getElementById('confirmacion-modal').style.display = 'flex';
        }

        // El script se inicia llamando a la funci√≥n de carga
        window.onload = cargarMenu; 

    </script>

</body>
</html>
